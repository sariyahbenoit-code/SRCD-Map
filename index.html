<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SRCD Map 3D Integration</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://api.mapbox.com/mapbox-gl-js/v3.17.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v3.17.0/mapbox-gl.js"></script>

<script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
<script src="https://unpkg.com/three@0.160.0/examples/js/loaders/GLTFLoader.js"></script>

<style>
html, body { margin:0; height:100%; overflow:hidden; background:transparent; }
#map { position:absolute; top:0; bottom:0; width:100%; }
#surfaceCanvas { position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:2; }
</style>
</head>

<body>

<div id="map"></div>
<canvas id="surfaceCanvas"></canvas>

<script>
/* -----------------------------------------------
   MAPBOX INITIALIZATION
------------------------------------------------ */
mapboxgl.accessToken =
  "pk.eyJ1Ijoic25iZW5vaSIsImEiOiJjbWg5Y2IweTAwbnRzMm5xMXZrNnFnbmY5In0.Lza9yPTlMhbHE5zHNRb1aA";

const map = new mapboxgl.Map({
    container: "map",
    style: "mapbox://styles/snbenoi/cmhjgr9hh000001rcf6cy38p0",
    center: [-122.5125, 37.9679],
    zoom: 13,
    pitch: 60,
    antialias: true
});

/* -----------------------------------------------
   RASTER IMAGE – SAME COORDINATES AS OLD SYSTEM
------------------------------------------------ */
const corners = [
  [-122.537464, 37.984078],
  [-122.477353, 37.984108],
  [-122.477370, 37.952203],
  [-122.537475, 37.952208]
];

const underUrl =
  "https://raw.githubusercontent.com/sariyahbenoit-code/SRCD-Map/main/assets/images/SFCD%20underground.jpg";

const surfaceUrl =
  "https://raw.githubusercontent.com/sariyahbenoit-code/SRCD-Map/main/assets/images/SRCD%20surface.jpg";

/* -----------------------------------------------
   LOAD MAP + RASTER + LANDMARKS
------------------------------------------------ */
map.on("load", () => {
    map.addSource("underground", {
        type: "image",
        url: underUrl,
        coordinates: corners
    });

    map.addLayer({
        id: "underground-layer",
        type: "raster",
        source: "underground",
        paint: { "raster-opacity": 1 }
    });

    /* -------- Landmarks (your old system) ------- */
    const landmarks = {
      "type": "FeatureCollection",
      "features": [
        {
          "type": "Feature",
          "properties": {
            "title": "Floating Housing",
            "address": "555 Francisco Blvd E, San Rafael, CA 94901",
            "proposal": "Floating housing precedent.",
            "image": "https://riyahniko.com/wp-content/uploads/2025/11/Screenshot-2025-11-03-at-9.43.05-AM.png"
          },
          "geometry": { "type": "Point", "coordinates": [-122.5036, 37.9720] }
        },
        {
          "type": "Feature",
          "properties": {
            "title": "Municipally Leased Storage",
            "address": "616 Canal St",
            "proposal": "Emergency supply storage.",
            "image": "https://riyahniko.com/wp-content/uploads/2025/11/Screenshot-2025-11-03-at-9.42.42-AM.png"
          },
          "geometry": { "type": "Point", "coordinates": [-122.5078, 37.9694] }
        },
        {
          "type": "Feature",
          "properties": {
            "title": "Solar Powered Pump Station",
            "address": "555 Francisco Blvd W",
            "proposal": "Vegetated forebay pumping.",
            "image": "https://riyahniko.com/wp-content/uploads/2025/11/fisheye-after-2048x1536.jpeg"
          },
          "geometry": { "type": "Point", "coordinates": [-122.5115, 37.9675] }
        }
      ]
    };

    map.addSource("landmarks", { type:"geojson", data:landmarks });

    map.addLayer({
        id: "landmarks-layer",
        type: "circle",
        source: "landmarks",
        paint: {
            "circle-radius": 8,
            "circle-color": "#fff",
            "circle-stroke-width": 2,
            "circle-stroke-color": "#000"
        }
    });

    map.on("click", "landmarks-layer", (e) => {
        const p = e.features[0].properties;
        new mapboxgl.Popup()
            .setLngLat(e.features[0].geometry.coordinates)
            .setHTML(`
              <h3>${p.title}</h3>
              <p><strong>Address:</strong> ${p.address}</p>
              <p>${p.proposal}</p>
              <img src="${p.image}">
            `)
            .addTo(map);
    });

    /* -----------------------------------------------
       HALO MASK CANVAS – SAME AS YOUR OLD SYSTEM
    ------------------------------------------------ */
    const canvas = document.getElementById("surfaceCanvas");
    const ctx = canvas.getContext("2d", { alpha:true });

    const surfaceImg = new Image();
    surfaceImg.crossOrigin = "anonymous";
    surfaceImg.src = surfaceUrl;

    let mouse = { x:-999, y:-999 };
    let haloRadius = 120;

    function resizeCanvas() {
        canvas.width = map.getContainer().clientWidth;
        canvas.height = map.getContainer().clientHeight;
    }
    resizeCanvas();
    window.addEventListener("resize", resizeCanvas);

    map.getCanvasContainer().addEventListener("mousemove", e => {
        const rect = canvas.getBoundingClientRect();
        mouse.x = e.clientX - rect.left;
        mouse.y = e.clientY - rect.top;
    });

    function getScreenCoords() {
        return {
          tl: map.project(corners[0]),
          tr: map.project(corners[1]),
          bl: map.project(corners[3])
        };
    }

    function drawSurface() {
        if (!surfaceImg.complete) return;

        ctx.clearRect(0,0,canvas.width,canvas.height);

        const { tl, tr, bl } = getScreenCoords();
        const w = tr.x - tl.x;
        const h = bl.y - tl.y;

        ctx.save();
        ctx.translate(tl.x, tl.y);
        ctx.drawImage(surfaceImg, 0, 0, w, h);

        ctx.globalCompositeOperation = "destination-out";
        const g = ctx.createRadialGradient(mouse.x, mouse.y, 20, mouse.x, mouse.y, haloRadius);
        g.addColorStop(0, "rgba(255,255,255,1)");
        g.addColorStop(1, "rgba(255,255,255,0)");
        ctx.fillStyle = g;
        ctx.beginPath();
        ctx.arc(mouse.x, mouse.y, haloRadius, 0, Math.PI*2);
        ctx.fill();
        ctx.restore();
    }

    function animate() {
        drawSurface();
        requestAnimationFrame(animate);
    }
    animate();

    /* -----------------------------------------------
       3D GLTF MODEL – CENTERED ON YOUR COORDINATES
    ------------------------------------------------ */
    const modelOrigin = [-122.5074155, 37.968649];  // center of your raster
    const modelAltitude = 0;
    const modelRotate = [Math.PI/2, 0, 0];

    const mc = mapboxgl.MercatorCoordinate.fromLngLat(modelOrigin, modelAltitude);

    const modelTransform = {
        translateX: mc.x,
        translateY: mc.y,
        translateZ: mc.z,
        rotateX: modelRotate[0],
        rotateY: modelRotate[1],
        rotateZ: modelRotate[2],
        scale: mc.meterInMercatorCoordinateUnits() * 1 // adjust for your model size!
    };

    const customLayer = {
        id: "gltf-model",
        type: "custom",
        renderingMode: "3d",

        onAdd: function (map, gl) {
            this.camera = new THREE.Camera();
            this.scene = new THREE.Scene();

            const light1 = new THREE.DirectionalLight(0xffffff, 1);
            light1.position.set(0, 70, 100).normalize();
            this.scene.add(light1);

            const loader = new THREE.GLTFLoader();
            loader.load(
                "https://sariyahbenoit-code.github.io/SRCD-Map/assets/images/forebay%20gltf.gltf",
                (gltf) => { this.scene.add(gltf.scene); }
            );

            this.renderer = new THREE.WebGLRenderer({
                canvas: map.getCanvas(),
                context: gl,
                antialias: true
            });
            this.renderer.autoClear = false;
        },

        render: function(gl, matrix) {
            const rotationX = new THREE.Matrix4().makeRotationAxis(new THREE.Vector3(1,0,0), modelTransform.rotateX);
            const rotationY = new THREE.Matrix4().makeRotationAxis(new THREE.Vector3(0,1,0), modelTransform.rotateY);
            const rotationZ = new THREE.Matrix4().makeRotationAxis(new THREE.Vector3(0,0,1), modelTransform.rotateZ);

            const m = new THREE.Matrix4().fromArray(matrix);
            const l = new THREE.Matrix4()
                .makeTranslation(modelTransform.translateX, modelTransform.translateY, modelTransform.translateZ)
                .scale(new THREE.Vector3(modelTransform.scale, -modelTransform.scale, modelTransform.scale))
                .multiply(rotationX).multiply(rotationY).multiply(rotationZ);

            this.camera.projectionMatrix = m.multiply(l);
            this.renderer.resetState();
            this.renderer.render(this.scene, this.camera);
            map.triggerRepaint();
        }
    };

    map.addLayer(customLayer);
});
</script>

</body>
</html>
